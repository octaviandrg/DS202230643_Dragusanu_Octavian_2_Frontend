{"ast":null,"code":"'use strict';\n\nvar Axes = require('../../plots/cartesian/axes');\n\nvar alignPeriod = require('../../plots/cartesian/align_period');\n\nvar mergeArray = require('../../lib').mergeArray;\n\nvar calcSelection = require('../scatter/calc_selection');\n\nvar BADNUM = require('../../constants/numerical').BADNUM;\n\nfunction isAbsolute(a) {\n  return a === 'a' || a === 'absolute';\n}\n\nfunction isTotal(a) {\n  return a === 't' || a === 'total';\n}\n\nmodule.exports = function calc(gd, trace) {\n  var xa = Axes.getFromId(gd, trace.xaxis || 'x');\n  var ya = Axes.getFromId(gd, trace.yaxis || 'y');\n  var size, pos, origPos, pObj, hasPeriod, pLetter;\n\n  if (trace.orientation === 'h') {\n    size = xa.makeCalcdata(trace, 'x');\n    origPos = ya.makeCalcdata(trace, 'y');\n    pObj = alignPeriod(trace, ya, 'y', origPos);\n    hasPeriod = !!trace.yperiodalignment;\n    pLetter = 'y';\n  } else {\n    size = ya.makeCalcdata(trace, 'y');\n    origPos = xa.makeCalcdata(trace, 'x');\n    pObj = alignPeriod(trace, xa, 'x', origPos);\n    hasPeriod = !!trace.xperiodalignment;\n    pLetter = 'x';\n  }\n\n  pos = pObj.vals; // create the \"calculated data\" to plot\n\n  var serieslen = Math.min(pos.length, size.length);\n  var cd = new Array(serieslen); // set position and size (as well as for waterfall total size)\n\n  var previousSum = 0;\n  var newSize; // trace-wide flags\n\n  var hasTotals = false;\n\n  for (var i = 0; i < serieslen; i++) {\n    var amount = size[i] || 0;\n    var connectToNext = false;\n\n    if (size[i] !== BADNUM || isTotal(trace.measure[i]) || isAbsolute(trace.measure[i])) {\n      if (i + 1 < serieslen && (size[i + 1] !== BADNUM || isTotal(trace.measure[i + 1]) || isAbsolute(trace.measure[i + 1]))) {\n        connectToNext = true;\n      }\n    }\n\n    var cdi = cd[i] = {\n      i: i,\n      p: pos[i],\n      s: amount,\n      rawS: amount,\n      cNext: connectToNext\n    };\n\n    if (isAbsolute(trace.measure[i])) {\n      previousSum = cdi.s;\n      cdi.isSum = true;\n      cdi.dir = 'totals';\n      cdi.s = previousSum;\n    } else if (isTotal(trace.measure[i])) {\n      cdi.isSum = true;\n      cdi.dir = 'totals';\n      cdi.s = previousSum;\n    } else {\n      // default: relative\n      cdi.isSum = false;\n      cdi.dir = cdi.rawS < 0 ? 'decreasing' : 'increasing';\n      newSize = cdi.s;\n      cdi.s = previousSum + newSize;\n      previousSum += newSize;\n    }\n\n    if (cdi.dir === 'totals') {\n      hasTotals = true;\n    }\n\n    if (hasPeriod) {\n      cd[i].orig_p = origPos[i]; // used by hover\n\n      cd[i][pLetter + 'End'] = pObj.ends[i];\n      cd[i][pLetter + 'Start'] = pObj.starts[i];\n    }\n\n    if (trace.ids) {\n      cdi.id = String(trace.ids[i]);\n    }\n\n    cdi.v = (trace.base || 0) + previousSum;\n  }\n\n  if (cd.length) cd[0].hasTotals = hasTotals;\n  mergeArray(trace.text, cd, 'tx');\n  mergeArray(trace.hovertext, cd, 'htx');\n  calcSelection(cd, trace);\n  return cd;\n};","map":null,"metadata":{},"sourceType":"script"}